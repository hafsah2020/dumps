<!DOCTYPE html>
<html>
<head>
  <title>Supermarkets Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
    .card {
      padding: 15px;
      border: 1px solid #ccc;
      border-radius: 8px;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .card:hover { box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
    #editModal {
      display: none;
      position: fixed; top:0; left:0; right:0; bottom:0;
      background: rgba(0,0,0,0.5);
      justify-content: center; align-items: center;
    }
    #editFormContainer {
      background: white; padding: 20px; border-radius: 8px; width: 400px;
    }
    label { display: block; margin: 10px 0 5px; }
    input, select { width: 100%; padding: 5px; margin-bottom: 10px; }
    button { padding: 8px 15px; }
  </style>
</head>
<body>
  <h1>Supermarkets Dashboard</h1>
  <div class="grid" id="supermarketGrid"></div>

  <!-- Edit Modal -->
  <div id="editModal">
    <div id="editFormContainer">
      <h2>Edit Supermarket</h2>
      <form id="editForm">
        <label>Stage:
          <select name="stage">
            <option>yet to contact</option>
            <option>contacted and promising</option>
            <option>contacted but unsure</option>
            <option>converted</option>
          </select>
        </label>
        <label>Phone: <input name="phone" type="text"/></label>
        <label>Email: <input name="email" type="email"/></label>
        <label>Address: <input name="address" type="text"/></label>
        <div style="text-align:right;">
          <button type="submit">Save</button>
          <button type="button" id="closeModal">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- PapaParse for Google Sheet CSV -->
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script>
    const supermarketGrid = document.getElementById("supermarketGrid");
    const editModal = document.getElementById("editModal");
    const editForm = document.getElementById("editForm");
    const closeModalBtn = document.getElementById("closeModal");

    let sheetLookup = {}; // Google Sheet data
    let geoJsonFeatureLookup = {}; // GeoJSON properties for name/link
    let currentID = null;

    // Load Google Sheet
    Papa.parse("https://docs.google.com/spreadsheets/d/e/YOUR_SHEET_URL/pub?output=csv", {
      download: true,
      header: true,
      complete: function(sheetData) {
        sheetData.data.forEach(row => {
          if (!row.ID) return;
          sheetLookup[row.ID] = {
            stage: row.Stage || "yet to contact",
            phone: row.Phone || "",
            email: row.Email || "",
            address: row.Address || ""
          };
        });

        // Load GeoJSON for coordinates, name, map link
        fetch("static/data/supermarkets_in_abuja.geojson")
          .then(res => res.json())
          .then(geoData => {
            geoData.features.forEach(f => {
              const id = f.properties.ID;
              geoJsonFeatureLookup[id] = f.properties;

              const sheetData = sheetLookup[id] || {};
              const card = document.createElement("div");
              card.className = "card";
              card.innerHTML = `
                <h3>${f.properties.super_market || "N/A"}</h3>
                <p><strong>Stage:</strong> ${sheetData.stage || "N/A"}</p>
                <p><strong>Phone:</strong> ${sheetData.phone || "N/A"}</p>
              `;
              card.addEventListener("click", () => openEditModal(id));
              supermarketGrid.appendChild(card);
            });
          });
      }
    });

    function openEditModal(id) {
      currentID = id;
      const sheetData = sheetLookup[id] || {};
      editForm.stage.value = sheetData.stage || "yet to contact";
      editForm.phone.value = sheetData.phone || "";
      editForm.email.value = sheetData.email || "";
      editForm.address.value = sheetData.address || "";
      editModal.style.display = "flex";
    }

    closeModalBtn.addEventListener("click", () => { editModal.style.display = "none"; });

    editForm.addEventListener("submit", async e => {
      e.preventDefault();
      if (!currentID) return;

      const payload = {
        ID: currentID,
        Stage: editForm.stage.value,
        Phone: editForm.phone.value,
        Email: editForm.email.value,
        Address: editForm.address.value
      };

      // Optional: push to Apps Script for persistence
      try {
        const res = await fetch("YOUR_APPSCRIPT_WEBAPP_URL", {
          method: "POST",
          body: JSON.stringify(payload)
        });
        const result = await res.json();
        if (!result.success) { alert("Update failed: " + result.error); return; }
      } catch(err) {
        console.error(err);
        alert("Failed to update sheet");
      }

      // Update local object & UI
      Object.assign(sheetLookup[currentID], payload);
      const card = [...supermarketGrid.children].find(c => c.querySelector("h3").textContent === geoJsonFeatureLookup[currentID].super_market);
      if (card) {
        card.innerHTML = `
          <h3>${geoJsonFeatureLookup[currentID].super_market}</h3>
          <p><strong>Stage:</strong> ${sheetLookup[currentID].stage}</p>
          <p><strong>Phone:</strong> ${sheetLookup[currentID].phone}</p>
        `;
      }

      editModal.style.display = "none";
    });
  </script>
</body>
</html>
